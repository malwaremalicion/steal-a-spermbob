<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Steal A Spermbob — Multiplayer</title>
<style>
  body{margin:0;font-family:Arial;background:#071018;color:#e6eef8}
  #top{padding:8px 12px;display:flex;align-items:center;gap:12px;background:rgba(0,0,0,0.2)}
  #money{font-weight:700} #status{margin-left:auto;color:#9aa6b2}
  #main{display:flex;gap:12px;padding:12px}
  #left{flex:1;background:linear-gradient(#05202b,#021018);padding:12px;border-radius:8px}
  #road{height:180px;background:linear-gradient(#0b2630,#041018);position:relative;overflow:hidden;border-radius:6px}
  .walker{position:absolute;display:flex;flex-direction:column;align-items:center;cursor:pointer}
  .walker img{width:40px;height:40px}
  #right{width:360px}
  .panel{background:rgba(255,255,255,0.02);padding:12px;border-radius:8px;margin-bottom:12px}
  .player-block{background:rgba(255,255,255,0.01);padding:8px;border-radius:8px;margin-bottom:8px}
  .slots{display:flex;gap:6px;flex-wrap:wrap}
  .slot{width:56px;height:56px;border-radius:8px;background:#07131a;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
  .slot .meta{position:absolute;bottom:0;left:0;right:0;font-size:11px;text-align:center;background:linear-gradient(transparent,rgba(0,0,0,0.5))}
  .steal-bar{position:absolute;left:0;bottom:0;height:6px;background:linear-gradient(90deg,#ef4444,#f97316);width:0%}
</style>
</head>
<body>
  <div id="top">
    <div id="money">Money: $<span id="moneyVal">30</span></div>
    <div id="roomShow">Room: <span id="roomLabel">—</span></div>
    <div id="status">Not connected</div>
  </div>

  <div id="main">
    <div id="left">
      <h3>Road</h3>
      <div id="road"></div>
    </div>
    <div id="right">
      <div class="panel">
        <input id="roomCode" placeholder="room code"/> <button id="join">Join</button>
      </div>
      <div id="collections" class="panel"></div>
    </div>
  </div>

<script>
const WS_URL = 'wss://spermbob-server.onrender.com';
const SELL_HOLD_MS = 5000;
const STEAL_TIMEOUT_MS = 15000;

let ws=null, myId=null, roomCode=null;
let players = {}, walkers = [];

// DOM refs
const moneyVal = document.getElementById('moneyVal');
const statusEl = document.getElementById('status');
const road = document.getElementById('road');
const roomLabel = document.getElementById('roomLabel');
const joinBtn = document.getElementById('join');
const roomCodeInp = document.getElementById('roomCode');
const collectionsDiv = document.getElementById('collections');

joinBtn.addEventListener('click', ()=> {
  const rc = roomCodeInp.value.trim() || 'lobby';
  roomCode = rc;
  roomLabel.textContent = roomCode;
  connect();
});

// Connect and wire ws
function connect(){
  if(ws && (ws.readyState===WebSocket.OPEN || ws.readyState===WebSocket.CONNECTING)) return;
  setStatus('Connecting...');
  ws = new WebSocket(WS_URL);
  ws.addEventListener('open', ()=> {
    setStatus('Connected');
    // join with a generated temporary username if none set
    const username = 'player' + Math.floor(Math.random()*9999);
    ws.send(JSON.stringify({ type:'joinRoom', roomCode, username, money:30 }));
  });
  ws.addEventListener('message', ev => {
    let msg;
    try{ msg = JSON.parse(ev.data); }catch(e){return;}
    handle(msg);
  });
  ws.addEventListener('close', ()=> setStatus('Disconnected'));
  ws.addEventListener('error', ()=> setStatus('Connection error'));
}

function setStatus(s){ statusEl.textContent = s; }

// Handle incoming messages
function handle(msg){
  if(msg.type === 'roomUpdate'){
    // replace local snapshot
    players = msg.players || {};
    walkers = msg.walkers || [];
    myId = msg.you || myId;
    // update money from server authoritative copy if available
    if(myId && players[myId]) moneyVal.textContent = Math.floor(players[myId].money || 0);
    renderWalkers();
    renderCollections();
    return;
  }
  if(msg.type === 'walkerSpawn'){ renderWalkers(); return; }
  if(msg.type === 'buy' && msg.itemId){
    // remove walker visually if present
    document.querySelectorAll('.walker').forEach(w => { if(w.dataset.id === msg.itemId) w.remove(); });
    return;
  }
  if(msg.type === 'sell' || msg.type === 'stealSuccess' || msg.type === 'stealBlocked'){
    // these will be reflected in subsequent roomUpdate
    return;
  }
}

// Render walkers from server list
function renderWalkers(){
  road.innerHTML = '';
  walkers.forEach(w => {
    const el = document.createElement('div');
    el.className = 'walker';
    el.style.left = Math.random() * 60 + '%';
    el.style.top = (20 + Math.random()*100) + 'px';
    el.dataset.id = w.id;
    el.dataset.cost = w.cost;
    el.dataset.mps = w.mps;
    el.dataset.type = w.type;
    el.innerHTML = `<img src="${w.type==='bellbob' ? 'bellbob.png' : 'spermbob.png'}" style="width:40px;height:40px"><div style="color:#fff;font-size:12px">${w.rarity} $${w.cost}</div>`;
    el.addEventListener('click', ()=> attemptBuy(w.id));
    road.appendChild(el);
  });
}

// Attempt buy: send only itemId + chosen slot (client asks for a free slot)
function attemptBuy(itemId){
  // pick a free slot in our local players copy (server authoritative will confirm)
  if(!myId || !players[myId]) { alert('not ready'); return; }
  const free = players[myId].collection ? players[myId].collection.findIndex(x => !x) : 0;
  if(free === -1){ alert('No free slot'); return; }
  ws.send(JSON.stringify({ type:'buy', slot: free, itemId }));
  // remove walker locally for immediate feedback (server will broadcast authoritative state)
  const node = document.querySelector(`.walker[data-id="${itemId}"]`);
  if(node) node.remove();
}

// Render collections vertically stacked per-player
function renderCollections(){
  collectionsDiv.innerHTML = '';
  const ids = Object.keys(players);
  ids.forEach(id => {
    const p = players[id];
    const block = document.createElement('div');
    block.className = 'player-block';
    block.innerHTML = `<div style="font-weight:700">${p.username || 'player'}</div>`;
    const slots = document.createElement('div'); slots.className = 'slots';
    const arr = p.collection || Array(8).fill(null);
    arr.forEach((it, idx) => {
      const s = document.createElement('div'); s.className = 'slot';
      if(it){
        const img = document.createElement('img'); img.src = (it.type==='bellbob') ? 'bellbob.png' : 'spermbob.png';
        img.style.width='48px'; img.style.height='48px';
        s.appendChild(img);
        const meta = document.createElement('div'); meta.className='meta'; meta.textContent = `${it.rarity} $${it.mps}/s`;
        s.appendChild(meta);
        if(id === myId){
          // my slot: hold to sell (5s)
          attachHoldSell(s, idx);
        } else {
          // other player's slot: start steal hold (client triggers server stealStart)
          attachHoldSteal(s, idx, id);
        }
      } else {
        s.style.opacity = 0.6;
      }
      slots.appendChild(s);
    });
    block.appendChild(slots);
    collectionsDiv.appendChild(block);
  });
}

// Hold-to-sell on your slot
function attachHoldSell(el, slotIndex){
  let raf = null, start = null, bar = null;
  function tick(ts){
    if(!start) start = ts;
    const pct = Math.min((ts - start) / SELL_HOLD_MS * 100, 100);
    bar.style.width = pct + '%';
    if(pct >= 100){
      cancel();
      ws.send(JSON.stringify({ type:'sell', slot: slotIndex }));
    } else raf = requestAnimationFrame(tick);
  }
  function startHold(){
    if(bar) bar.remove();
    bar = document.createElement('div'); bar.className = 'steal-bar'; el.appendChild(bar);
    start = null; raf = requestAnimationFrame(tick);
  }
  function cancel(){
    if(raf) cancelAnimationFrame(raf); raf = null; start = null;
    if(bar) { bar.remove(); bar = null; }
  }
  el.addEventListener('mousedown', e => { if(e.button !== 0) return; startHold(); });
  el.addEventListener('mouseup', cancel); el.addEventListener('mouseleave', cancel);
  el.addEventListener('contextmenu', e => { e.preventDefault(); ws.send(JSON.stringify({ type:'sell', slot: slotIndex })); });
}

// Hold-to-steal on another player's slot
function attachHoldSteal(el, slotIndex, victimId){
  let raf = null, start = null, bar = null;
  function tick(ts){
    if(!start) start = ts;
    const pct = Math.min((ts - start) / STEAL_TIMEOUT_MS * 100, 100);
    bar.style.width = pct + '%';
    if(pct >= 100){ cancel(); /* server will apply transfer after its own timeout */ }
    else raf = requestAnimationFrame(tick);
  }
  function startHold(){
    if(bar) bar.remove();
    bar = document.createElement('div'); bar.className = 'steal-bar'; el.appendChild(bar);
    ws.send(JSON.stringify({ type:'stealStart', victimId, slot: slotIndex }));
    start = null; raf = requestAnimationFrame(tick);
  }
  function cancel(){ if(raf) cancelAnimationFrame(raf); raf=null; start=null; if(bar){ bar.remove(); bar=null; } }
  el.addEventListener('mousedown', e => { if(e.button !== 0) return; startHold(); });
  el.addEventListener('mouseup', cancel); el.addEventListener('mouseleave', cancel);
}

// helper: update money UI if server provides authoritative value
setInterval(()=>{
  if(myId && players[myId]) moneyVal.textContent = Math.floor(players[myId].money || 0);
}, 500);

// allow victim to press arrow key to block (sends stealBlocked to server with victimId and slot null — server will match)
document.addEventListener('keydown', e => {
  if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)){
    if(!myId) return;
    // best-effort: try to block all active steals targeted at me (server will match by victim id and slot)
    ws.send(JSON.stringify({ type:'stealBlocked', victimId: myId, slot: null }));
  }
});

</script>
</body>
</html>

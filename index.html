<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Steal A Spermbob â€” Multiplayer</title>
<style>
  body{margin:0;font-family:Arial;background:#071018;color:#e6eef8}
  #top{padding:8px 12px;display:flex;align-items:center;gap:12px;background:rgba(0,0,0,0.2)}
  #money{font-weight:700} #status{margin-left:auto;color:#9aa6b2}
  #main{display:flex;gap:12px;padding:12px}
  #left{flex:1;background:linear-gradient(#05202b,#021018);padding:12px;border-radius:8px}
  #road{height:180px;background:linear-gradient(#0b2630,#041018);position:relative;overflow:hidden;border-radius:6px}
  .walker{position:absolute;display:flex;flex-direction:column;align-items:center;cursor:pointer}
  .walker img{width:40px;height:40px}
  #right{width:360px}
  .panel{background:rgba(255,255,255,0.02);padding:12px;border-radius:8px;margin-bottom:12px}
  .player-block{background:rgba(255,255,255,0.01);padding:8px;border-radius:8px;margin-bottom:8px}
  .slots{display:flex;gap:6px;flex-wrap:wrap}
  .slot{width:56px;height:56px;border-radius:8px;background:#07131a;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
  .slot .meta{position:absolute;bottom:0;left:0;right:0;font-size:11px;text-align:center;background:linear-gradient(transparent,rgba(0,0,0,0.5))}
  .steal-bar{position:absolute;left:0;bottom:0;height:6px;background:linear-gradient(90deg,#ef4444,#f97316);width:0%}
</style>
</head>
<body>
  <div id="top">
    <div id="money">Money: $<span id="moneyVal">30</span></div>
    <div id="roomShow">Room: <span id="roomLabel">â€”</span></div>
    <div id="status">Not connected</div>
  </div>

  <div id="main">
    <div id="left">
      <h3>Road</h3>
      <div id="road"></div>
    </div>
    <div id="right">
      <div class="panel">
        <input id="roomCode" placeholder="room code"/> <button id="join">Join</button>
      </div>
      <div id="collections" class="panel"></div>
    </div>
  </div>

<script>
const WS_URL = 'wss://spermbob-server.onrender.com';
const SELL_HOLD_MS = 5000;
const STEAL_TIMEOUT_MS = 15000;

let ws=null, myId=null, roomCode=null;
let players = {}, walkers = [];

// DOM refs
const moneyVal = document.getElementById('moneyVal');
const statusEl = document.getElementById('status');
const road = document.getElementById('road');
const roomLabel = document.getElementById('roomLabel');
const joinBtn = document.getElementById('join');
const roomCodeInp = document.getElementById('roomCode');
const collectionsDiv = document.getElementById('collections');

joinBtn.addEventListener('click', ()=> {
  const rc = roomCodeInp.value.trim() || 'lobby';
  roomCode = rc;
  roomLabel.textContent = roomCode;
  connect();
});

// Connect and wire ws
function connect(){
  if(ws && (ws.readyState===WebSocket.OPEN || ws.readyState===WebSocket.CONNECTING)) return;
  setStatus('Connecting...');
  ws = new WebSocket(WS_URL);
  ws.addEventListener('open', ()=> {
    setStatus('Connected');
    // join with a generated temporary username if none set
    const username = 'player' + Math.floor(Math.random()*9999);
    ws.send(JSON.stringify({ type:'joinRoom', roomCode, username, money:30 }));
  });
  ws.addEventListener('message', ev => {
    let msg;
    try{ msg = JSON.parse(ev.data); }catch(e){return;}
    handle(msg);
  });
  ws.addEventListener('close', ()=> setStatus('Disconnected'));
  ws.addEventListener('error', ()=> setStatus('Connection error'));
}

function setStatus(s){ statusEl.textContent = s; }

// Handle incoming messages
function handle(msg){
  if(msg.type === 'roomUpdate'){
    // replace local snapshot
    players = msg.players || {};
    walkers = msg.walkers || [];
    myId = msg.you || myId;
    // update money from server authoritative copy if available
    if(myId && players[myId]) moneyVal.textContent = Math.floor(players[myId].money || 0);
    renderWalkers();
    renderCollections();
    return;
  }
  if(msg.type === 'walkerSpawn'){ renderWalkers(); return; }
  if(msg.type === 'buy' && msg.itemId){
    // remove walker visually if present
    document.querySelectorAll('.walker').forEach(w => { if(w.dataset.id === msg.itemId) w.remove(); });
    return;
  }
  if(msg.type === 'sell' || msg.type === 'stealSuccess' || msg.type === 'stealBlocked'){
    // these will be reflected in subsequent roomUpdate
    return;
  }
}

// Render walkers from server list
// Render walkers from server list (now smooth, persistent elements)
function renderWalkers(){
  // Keep already-spawned walkers instead of clearing
  const existing = {};

  document.querySelectorAll('.walker').forEach(el => {
    existing[el.dataset.id] = el;
  });

  walkers.forEach(w => {
    let el = existing[w.id];

    if(!el){
      // create walker once
      el = document.createElement('div');
      el.className = 'walker';
      el.dataset.id = w.id;
      el.dataset.cost = w.cost;
      el.dataset.mps = w.mps;
      el.dataset.type = w.type;

      // random initial position
      el._x = Math.random() * (road.clientWidth - 40);
      el._y = 20 + Math.random()*100;

      el.innerHTML = `
        <img src="${w.type==='bellbob' ? 'bellbob.png' : 'spermbob.png'}">
        <div style="color:#fff;font-size:12px">${w.rarity} $${w.cost}</div>
      `;

      el.addEventListener('click', ()=> attemptBuy(w.id));
      road.appendChild(el);
    }
  });
}
// Attempt buy: send only itemId + chosen slot (client asks for a free slot)
function attemptBuy(itemId){
  // pick a free slot in our local players copy (server authoritative will confirm)
  if(!myId || !players[myId]) { alert('not ready'); return; }
  const free = players[myId].collection ? players[myId].collection.findIndex(x => !x) : 0;
  if(free === -1){ alert('No free slot'); return; }
  ws.send(JSON.stringify({ type:'buy', slot: free, itemId }));
  // remove walker locally for immediate feedback (server will broadcast authoritative state)
  const node = document.querySelector(`.walker[data-id="${itemId}"]`);
  if(node) node.remove();
}

// Render collections vertically stacked per-player
function renderCollections(){
  collectionsDiv.innerHTML = '';
  const ids = Object.keys(players);
  ids.forEach(id => {
    const p = players[id];
    const block = document.createElement('div');
    block.className = 'player-block';
    block.innerHTML = `<div style="font-weight:700">${p.username || 'player'}</div>`;
    const slots = document.createElement('div'); slots.className = 'slots';
    const arr = p.collection || Array(8).fill(null);
    arr.forEach((it, idx) => {
      const s = document.createElement('div'); s.className = 'slot';
      if(it){
        const img = document.createElement('img'); img.src = (it.type==='bellbob') ? 'bellbob.png' : 'spermbob.png';
        img.style.width='48px'; img.style.height='48px';
        s.appendChild(img);
        const meta = document.createElement('div'); meta.className='meta'; meta.textContent = `${it.rarity} $${it.mps}/s`;
        s.appendChild(meta);
        if(id === myId){
          // my slot: hold to sell (5s)
          attachHoldSell(s, idx);
        } else {
          // other player's slot: start steal hold (client triggers server stealStart)
          attachHoldSteal(s, idx, id);
        }
      } else {
        s.style.opacity = 0.6;
      }
      slots.appendChild(s);
    });
    block.appendChild(slots);
    collectionsDiv.appendChild(block);
  });
}

// Hold-to-sell on your slot
function attachHoldSell(el, slotIndex){
  let raf = null, start = null, bar = null;
  function tick(ts){
    if(!start) start = ts;
    const pct = Math.min((ts - start) / SELL_HOLD_MS * 100, 100);
    bar.style.width = pct + '%';
    if(pct >= 100){
      cancel();
      ws.send(JSON.stringify({ type:'sell', slot: slotIndex }));
    } else raf = requestAnimationFrame(tick);
  }
  function startHold(){
    if(bar) bar.remove();
    bar = document.createElement('div'); bar.className = 'steal-bar'; el.appendChild(bar);
    start = null; raf = requestAnimationFrame(tick);
  }
  function cancel(){
    if(raf) cancelAnimationFrame(raf); raf = null; start = null;
    if(bar) { bar.remove(); bar = null; }
  }
  el.addEventListener('mousedown', e => { if(e.button !== 0) return; startHold(); });
  el.addEventListener('mouseup', cancel); el.addEventListener('mouseleave', cancel);
  el.addEventListener('contextmenu', e => { e.preventDefault(); ws.send(JSON.stringify({ type:'sell', slot: slotIndex })); });
}

// Hold-to-steal on another player's slot
function attachHoldSteal(el, slotIndex, victimId){
  let raf = null, start = null, bar = null;
  function tick(ts){
    if(!start) start = ts;
    const pct = Math.min((ts - start) / STEAL_TIMEOUT_MS * 100, 100);
    bar.style.width = pct + '%';
    if(pct >= 100){ cancel(); /* server will apply transfer after its own timeout */ }
    else raf = requestAnimationFrame(tick);
  }
  function startHold(){
    if(bar) bar.remove();
    bar = document.createElement('div'); bar.className = 'steal-bar'; el.appendChild(bar);
    ws.send(JSON.stringify({ type:'stealStart', victimId, slot: slotIndex }));
    start = null; raf = requestAnimationFrame(tick);
  }
  function cancel(){ if(raf) cancelAnimationFrame(raf); raf=null; start=null; if(bar){ bar.remove(); bar=null; } }
  el.addEventListener('mousedown', e => { if(e.button !== 0) return; startHold(); });
  el.addEventListener('mouseup', cancel); el.addEventListener('mouseleave', cancel);
}

// helper: update money UI if server provides authoritative value
setInterval(()=>{
  if(myId && players[myId]) moneyVal.textContent = Math.floor(players[myId].money || 0);
}, 500);

// allow victim to press arrow key to block (sends stealBlocked to server with victimId and slot null â€” server will match)
document.addEventListener('keydown', e => {
  if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)){
    if(!myId) return;
    // best-effort: try to block all active steals targeted at me (server will match by victim id and slot)
    ws.send(JSON.stringify({ type:'stealBlocked', victimId: myId, slot: null }));
  }
});
/* ==========================================================
   CONFIG
========================================================== */
const WS_URL = "wss://spermbob-server.onrender.com";
let ws;
let yourId = null;

/* ==========================================================
   STATE
========================================================== */
let players = {};
let localCollection = Array(8).fill(null);
let localMoney = 30;
let walkers = []; // each walker = {x, speed, el, type}

/* ==========================================================
   DOM ELEMENTS
========================================================== */
const usernameInput = document.getElementById("usernameInput");
const roomCodeInput = document.getElementById("roomCodeInput");
const joinBtn = document.getElementById("joinBtn");
const playersContainer = document.getElementById("playersContainer");
const walkersContainer = document.getElementById("walkersContainer");

/* ==========================================================
   JOIN ROOM
========================================================== */
joinBtn.onclick = () => {
    const username = usernameInput.value.trim();
    const room = roomCodeInput.value.trim();
    if (!username || !room) return alert("Enter username + room code");

    connectWS(username, room);
};

/* ==========================================================
   CONNECT WEBSOCKET
========================================================== */
function connectWS(username, room) {
    ws = new WebSocket(WS_URL);

    ws.onopen = () => {
        ws.send(JSON.stringify({
            type: "joinRoom",
            username,
            roomCode: room,
            money: 30
        }));
    };

    ws.onmessage = (msg) => {
        const data = JSON.parse(msg.data);
        handleServerMessage(data);
    };

    ws.onclose = () => {
        console.warn("Disconnected. Reconnecting in 2s...");
        setTimeout(() => connectWS(username, room), 2000);
    };
}

/* ==========================================================
   SAFE SEND
========================================================== */
function safeSend(obj) {
    if (!ws || ws.readyState !== 1) return;
    ws.send(JSON.stringify(obj));
}

/* ==========================================================
   HANDLE SERVER MESSAGES
========================================================== */
function handleServerMessage(data) {
    if (data.type === "roomUpdate") {
        players = data.players;
        yourId = data.you || yourId;

        // Sync collection + money with server copy of YOU
        if (players[yourId]) {
            localCollection = players[yourId].collection;
            localMoney = players[yourId].money;
        }

        renderPlayers();
    }

    if (data.type === "stealStart") {
        showStealBar(data.thiefId, data.victimId, data.slot);
    }

    if (data.type === "stealBlocked") {
        hideStealBar(data.victimId, data.slot);
    }

    if (data.type === "stealSuccess") {
        hideStealBar(data.victimId, data.slot);
    }
}

/* ==========================================================
   RENDER PLAYERS + COLLECTIONS
========================================================== */
function renderPlayers() {
    playersContainer.innerHTML = "";

    for (const id in players) {
        const p = players[id];

        const div = document.createElement("div");
        div.className = "playerCard";

        div.innerHTML = `
            <div class="playerName">${p.username}</div>
            <div class="money">$${p.money}</div>
            <div class="collection"></div>
        `;

        const col = div.querySelector(".collection");

        p.collection.forEach((item, slot) => {
            const slotDiv = document.createElement("div");
            slotDiv.className = "slot";

            if (item) {
                slotDiv.textContent = item.name;
            } else {
                slotDiv.textContent = "[empty]";
            }

            // YOUR SLOTS get interaction
            if (id === yourId) {
                slotDiv.onmousedown = () => startSell(slot);
                slotDiv.onmouseup = stopHold;
                slotDiv.onmouseleave = stopHold;
            } else {
                // Enemy slots = stealing
                slotDiv.onmousedown = () => startSteal(id, slot);
                slotDiv.onmouseup = stopHold;
                slotDiv.onmouseleave = stopHold;
            }

            col.appendChild(slotDiv);
        });

        playersContainer.appendChild(div);
    }
}

/* ==========================================================
   SELL / STEAL HOLD LOGIC
========================================================== */
let holdTimer = null;
const HOLD_TIME = 1500; // 1.5s

function stopHold() {
    if (holdTimer) {
        clearTimeout(holdTimer);
        holdTimer = null;
    }
}

function startSell(slot) {
    stopHold();
    holdTimer = setTimeout(() => {
        safeSend({
            type: "sell",
            slot
        });
    }, HOLD_TIME);
}

function startSteal(victimId, slot) {
    stopHold();
    holdTimer = setTimeout(() => {
        safeSend({
            type: "stealStart",
            victimId,
            slot
        });
    }, HOLD_TIME);
}

/* ==========================================================
   OPTIONAL: SHOW STEAL BAR
========================================================== */
function showStealBar(thiefId, victimId, slot) {
    // Add UI later if needed
}
function hideStealBar(victimId, slot) {}

/* ==========================================================
   WALKER SPAWNING + SMOOTH MOVEMENT
========================================================== */
function spawnWalker() {
    const walker = {
        x: -100,
        speed: 50 + Math.random() * 40,
        type: "walker",
        el: null
    };

    const el = document.createElement("div");
    el.className = "walker";
    el.textContent = "ðŸš¶";
    walkersContainer.appendChild(el);

    walker.el = el;
    walkers.push(walker);

    // Click to buy walker
    el.onmousedown = () => beginBuyWalker(walker);
    el.onmouseup = stopHold;
    el.onmouseleave = stopHold;
}

// BUY WALKER
function beginBuyWalker(w) {
    stopHold();
    holdTimer = setTimeout(() => {
        const freeSlot = localCollection.findIndex(c => c === null);
        if (freeSlot === -1) return alert("No space!");

        safeSend({
            type: "buy",
            slot: freeSlot,
            item: {
                name: "Walker",
                cost: 5,
                mps: 1
            }
        });

        // Remove walker visually:
        w.el.remove();
        walkers = walkers.filter(x => x !== w);

    }, HOLD_TIME);
}
// Smooth walker movement
function animateWalkers(){
  const all = document.querySelectorAll('.walker');
  all.forEach(el => {
    // drift speed
    const speed = 0.3;

    el._x += speed;

    // wrap around screen
    if(el._x > road.clientWidth) el._x = -40;

    el.style.left = el._x + "px";
    el.style.top = el._y + "px";
  });

  requestAnimationFrame(animateWalkers);
}
requestAnimationFrame(animateWalkers);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Steal A Spermbob Multiplayer</title>
<style>
body { background:#222; color:white; font-family:Arial; overflow:hidden; margin:0; }
#road { position:absolute; top:50px; left:0; width:100%; height:120px; background:#444; }
.walker { position:absolute; width:48px; height:48px; cursor:pointer; }
.label { font-size:12px; text-align:center; color:white; text-shadow:0 0 4px black; }
#playersCollections { position:absolute; bottom:10px; left:50%; transform:translateX(-50%); display:flex; gap:40px; overflow-x:auto; max-width:90%; }
.collection { display:flex; flex-direction:column; align-items:center; gap:5px; }
.collection .slot { width:48px; height:48px; border:1px solid #555; background:#333; position:relative; cursor:pointer; }
.collection .slot img { width:100%; height:100%; pointer-events:none; }
#money { position:absolute; left:10px; top:10px; font-size:22px; }
#usernameScreen { position:fixed; inset:0; background:#000a; display:flex; justify-content:center; align-items:center; }
#usernameScreen div { background:#222; padding:20px; border-radius:12px; text-align:center; color:white; width:260px; }
.stealProgressBar { position:absolute; height:5px; background:red; width:0; bottom:0; left:0; }
</style>
</head>
<body>

<div id="money">$30</div>
<div id="road"></div>
<div id="playersCollections"></div>

<div id="usernameScreen">
<div>
<h2>Enter Username</h2>
<input id="usernameInput" placeholder="Username" style="width:100%; padding:8px; margin:10px 0;">
<h2>Room Code</h2>
<input id="roomInput" placeholder="Room code" style="width:100%; padding:8px; margin:10px 0;">
<button id="joinBtn" style="padding:8px 12px;">Join Room</button>
</div>
</div>

<audio id="bgm" src="bgm.mp3" loop></audio>

<script>
let ws, playerId;
let username, roomCode;
let money = 30;
let collection = Array(8).fill(null);
let playersData = {};
let activeSteals = {}; // {"victimId_slot": {progress:0, interval:null}}

const playersCollections = document.getElementById('playersCollections');
const road = document.getElementById('road');
const moneyDiv = document.getElementById('money');

document.getElementById('joinBtn').onclick = () => {
    username = document.getElementById('usernameInput').value.trim();
    roomCode = document.getElementById('roomInput').value.trim();
    if(!username || !roomCode) return;
    document.getElementById('usernameScreen').style.display='none';
    document.getElementById('bgm').play().catch(()=>{});
    connect();
}

function connect(){
    ws = new WebSocket('wss://spermbob-server.onrender.com');
    ws.onopen = () => ws.send(JSON.stringify({ type:'joinRoom', username, roomCode }));
    ws.onmessage = e => handleMessage(JSON.parse(e.data));
}

function handleMessage(data){
    if(data.type==='roomUpdate'){
        if(!playerId) playerId = data.you;
        playersData = data.players;
        renderPlayersCollections(playersData);
    } else if(data.type==='buy'){
        removeWalker(data.itemId);
    } else if(data.type==='stealStart'){
        startStealBar(data.thiefId, data.victimId, data.slot);
        if(data.victimId===playerId) alert(`Someone is stealing your item in slot ${data.slot}! Press arrow keys to block!`);
    } else if(data.type==='stealBlocked'){
        stopStealBar(data.thiefId, data.victimId, data.slot);
        if(data.victimId===playerId) alert('Steal blocked!');
    } else if(data.type==='stealSuccess'){
        stopStealBar(data.thiefId, data.victimId, data.slot);
        alert('Item stolen!');
        if(data.victimId===playerId){
            collection[data.slot] = null; // remove stolen item
        }
    }
}

function renderPlayersCollections(players){
    playersCollections.innerHTML='';
    for(let id in players){
        const p = players[id];
        const colDiv = document.createElement('div');
        colDiv.className='collection';
        const nameDiv = document.createElement('div'); 
        nameDiv.innerText = p.username + (id===playerId?' (You)':'');
        colDiv.appendChild(nameDiv);

        for(let i=0;i<8;i++){
            const slot = document.createElement('div'); slot.className='slot';
            if(p.collection[i]){
                const img = document.createElement('img');
                img.src=p.collection[i].type==='spermbob'?'spermbob.png':'bellbob.png';
                slot.appendChild(img);
                const lab = document.createElement('div'); lab.className='label';
                lab.innerText=`${p.collection[i].rarity} | $${p.collection[i].mps}/s`;
                slot.appendChild(lab);
                const bar = document.createElement('div'); bar.className='stealProgressBar';
                slot.appendChild(bar);
                if(id !== playerId){
                    slot.onclick = ()=>ws.send(JSON.stringify({ type:'stealStart', victimId:id, slot:i }));
                } else {
                    slot.oncontextmenu = e=>{ // right click to sell
                        e.preventDefault();
                        collection[i]=null;
                        ws.send(JSON.stringify({ type:'update', collection, money }));
                        renderPlayersCollections(playersData);
                    }
                }
            }
            colDiv.appendChild(slot);
        }
        playersCollections.appendChild(colDiv);
    }
}

// --- Walkers ---
function spawnWalker(){
    const types = ['spermbob','bellbob'];
    const rarities = [
        {name:"Common", cost:10, mps:1},
        {name:"Uncommon", cost:25, mps:3},
        {name:"Rare", cost:60, mps:7},
        {name:"Epic", cost:150, mps:15}
    ];
    const type = types[Math.floor(Math.random()*types.length)];
    const rarity = rarities[Math.floor(Math.random()*rarities.length)];
    const div = document.createElement('div'); div.className='walker';
    div.style.left='-50px'; div.dataset.type=type; div.dataset.rarity=rarity.name;
    div.dataset.cost=rarity.cost; div.dataset.mps=rarity.mps; div.dataset.id=Math.random().toString(36).substr(2,9);
    const img = document.createElement('img'); img.src=type+'.png'; img.style.width='48px'; img.style.height='48px';
    div.appendChild(img);
    const label = document.createElement('div'); label.className='label';
    label.innerText=`${rarity.name} | $${rarity.mps}/s | Cost:${rarity.cost}`;
    div.appendChild(label);
    div.onclick = ()=>buy(div);
    road.appendChild(div);
    let x=-50; const speed = 1+Math.random();
    function move(){ x+=speed; div.style.left=x+'px'; if(x>window.innerWidth+50) div.remove(); else requestAnimationFrame(move); }
    move();
}
setInterval(spawnWalker,2000);

function buy(div){
    const cost = Number(div.dataset.cost);
    if(money<cost) return;
    money -= cost; moneyDiv.innerText='$'+money;
    const slotIndex = collection.findIndex(s=>!s);
    if(slotIndex!==-1){
        collection[slotIndex] = { type:div.dataset.type, rarity:div.dataset.rarity, mps:Number(div.dataset.mps) };
        ws.send(JSON.stringify({ type:'buy', slot:slotIndex, item:collection[slotIndex], itemId:div.dataset.id }));
    }
    div.remove();
}

function removeWalker(id){
    document.querySelectorAll('.walker').forEach(w=>{ if(w.dataset.id===id) w.remove(); });
}

// --- Money per second ---
setInterval(()=>{
    let total=0;
    for(let i=0;i<collection.length;i++){ if(collection[i]) total+=collection[i].mps; }
    money+=total; moneyDiv.innerText='$'+money;
    ws.send(JSON.stringify({ type:'update', collection, money }));
},1000);

// --- Multiplayer steal bar ---
function startStealBar(thiefId, victimId, slot){
    const key = victimId + '_' + slot;
    if(activeSteals[key]) return;
    activeSteals[key]={progress:0};
    const bar = document.querySelectorAll('.collection')[getPlayerIndex(victimId)]
                  .querySelectorAll('.slot')[slot].querySelector('.stealProgressBar');
    activeSteals[key].interval = setInterval(()=>{
        activeSteals[key].progress += 1;
        if(bar) bar.style.width = (activeSteals[key].progress*100/15)+'%';
        if(activeSteals[key].progress>=15){
            clearInterval(activeSteals[key].interval);
            ws.send(JSON.stringify({ type:'stealSuccess', victimId, slot }));
            delete activeSteals[key];
        }
    },1000);
}

function stopStealBar(thiefId, victimId, slot){
    const key = victimId + '_' + slot;
    if(activeSteals[key]){
        clearInterval(activeSteals[key].interval);
        const bar = document.querySelectorAll('.collection')[getPlayerIndex(victimId)]
                      .querySelectorAll('.slot')[slot].querySelector('.stealProgressBar');
        if(bar) bar.style.width='0%';
        delete activeSteals[key];
    }
}

document.addEventListener('keydown', e=>{
    if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)){
        for(const key in activeSteals){
            const [victimId, slot] = key.split('_');
            if(victimId===playerId){
                ws.send(JSON.stringify({ type:'stealBlocked', victimId, slot }));
                stopStealBar(null, victimId, slot);
            }
        }
    }
});

function getPlayerIndex(id){
    const divs = document.querySelectorAll('.collection');
    for(let i=0;i<divs.length;i++){
        if(divs[i].querySelector('div').innerText.includes(playersData[id].username)) return i;
    }
    return 0;
}
</script>
</body>
</html>

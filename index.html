<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Steal A Spermbob — Multiplayer</title>
<style>
  body{margin:0;font-family:Arial;background:#071018;color:#e6eef8}
  #top{padding:8px 12px;display:flex;align-items:center;gap:12px;background:rgba(0,0,0,0.2)}
  #money{font-weight:700} #status{margin-left:auto;color:#9aa6b2}
  #main{display:flex;gap:12px;padding:12px}
  #left{flex:1;background:linear-gradient(#05202b,#021018);padding:12px;border-radius:8px}
  #road{height:180px;background:linear-gradient(#0b2630,#041018);position:relative;overflow:hidden;border-radius:6px}
  .walker{position:absolute;display:flex;flex-direction:column;align-items:center;cursor:pointer;transition: top 0.2s linear;}
  .walker img{width:40px;height:40px}
  #right{width:360px}
  .panel{background:rgba(255,255,255,0.02);padding:12px;border-radius:8px;margin-bottom:12px}
  .player-block{background:rgba(255,255,255,0.01);padding:8px;border-radius:8px;margin-bottom:8px}
  .slots{display:flex;gap:6px;flex-wrap:wrap}
  .slot{width:56px;height:56px;border-radius:8px;background:#07131a;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
  .slot .meta{position:absolute;bottom:0;left:0;right:0;font-size:11px;text-align:center;background:linear-gradient(transparent,rgba(0,0,0,0.5))}
  .steal-bar{position:absolute;left:0;bottom:0;height:6px;background:linear-gradient(90deg,#ef4444,#f97316);width:0%}
</style>
</head>
<body>
  <audio id="bgm" loop autoplay>
    <source src="bgm.mp3" type="audio/mpeg">
  </audio>

  <div id="top">
    <div id="money">Money: $<span id="moneyVal">30</span></div>
    <div id="roomShow">Room: <span id="roomLabel">—</span></div>
    <div id="status">Not connected</div>
  </div>

  <div id="main">
    <div id="left">
      <h3>Road</h3>
      <div id="road"></div>
    </div>
    <div id="right">
      <div class="panel">
        <input id="roomCode" placeholder="room code"/> <button id="join">Join</button>
      </div>
      <div id="collections" class="panel"></div>
    </div>
  </div>

<script>
const WS_URL = 'wss://spermbob-server-production.up.railway.app';
const SELL_HOLD_MS = 5000;
const STEAL_TIMEOUT_MS = 15000;

let ws=null, myId=null, roomCode=null;
let players = {}, walkers = [];

// DOM refs
const moneyVal = document.getElementById('moneyVal');
const statusEl = document.getElementById('status');
const road = document.getElementById('road');
const roomLabel = document.getElementById('roomLabel');
const joinBtn = document.getElementById('join');
const roomCodeInp = document.getElementById('roomCode');
const collectionsDiv = document.getElementById('collections');
const bgm = document.getElementById('bgm');

joinBtn.addEventListener('click', ()=> {
  const rc = roomCodeInp.value.trim() || 'lobby';
  roomCode = rc;
  roomLabel.textContent = roomCode;
  connect();
});

// Connect and wire ws
function connect(){
  if(ws && (ws.readyState===WebSocket.OPEN || ws.readyState===WebSocket.CONNECTING)) return;
  setStatus('Connecting...');
  ws = new WebSocket(WS_URL);
  ws.addEventListener('open', ()=> {
    setStatus('Connected');
    // prompt username
    let username = prompt("Enter your username") || 'player'+Math.floor(Math.random()*9999);
    ws.send(JSON.stringify({ type:'joinRoom', roomCode, username, money:30 }));
  });
  ws.addEventListener('message', ev => {
    let msg;
    try{ msg = JSON.parse(ev.data); }catch(e){return;}
    handle(msg);
  });
  ws.addEventListener('close', ()=> setStatus('Disconnected'));
  ws.addEventListener('error', ()=> setStatus('Connection error'));
}

function setStatus(s){ statusEl.textContent = s; }

// Handle incoming messages
function handle(msg){
  if(msg.type === 'roomUpdate'){
    players = msg.players || {};
    walkers = msg.walkers || [];
    myId = msg.you || myId;
    if(myId && players[myId]) moneyVal.textContent = Math.floor(players[myId].money || 0);
    return;
  }
}

// Render walkers smoothly
function renderWalkers(){
  // create walker elements if not exist
  walkers.forEach(w => {
    if(!w.el){
      w.el = document.createElement('div');
      w.el.className = 'walker';
      w.el.innerHTML = `<img src="${w.type==='bellbob'?'bellbob.png':'spermbob.png'}" style="width:40px;height:40px">
                        <div style="color:#fff;font-size:12px">${w.rarity} $${w.cost}</div>`;
      road.appendChild(w.el);
      w.x = Math.random()*60;
      w.y = 20 + Math.random()*100;
    }
  });

  // animate
  walkers.forEach(w => {
    w.x += 0.2; // adjust speed
    if(w.x>100) w.x=-10;
    w.el.style.left = w.x + '%';
    w.el.style.top = w.y + 'px';
  });

  requestAnimationFrame(renderWalkers);
}
renderWalkers();

// spawn walkers periodically if empty
setInterval(()=>{
  if(walkers.length<5){ // max 5 at a time
    const w = {
      id:'w'+Math.floor(Math.random()*999999),
      type: Math.random()>0.5?'bellbob':'spermbob',
      rarity:'common',
      cost:10,
      mps:1
    };
    walkers.push(w);
  }
}, 3000);

// Attempt buy: pick free slot
function attemptBuy(itemId){
  if(!myId || !players[myId]) return;
  const free = players[myId].collection ? players[myId].collection.findIndex(x=>!x) : 0;
  if(free===-1){ alert('No free slot'); return; }
  ws.send(JSON.stringify({ type:'buy', slot: free, itemId }));
  const node = document.querySelector(`.walker[data-id="${itemId}"]`);
  if(node) node.remove();
}

// Render player collections
function renderCollections(){
  collectionsDiv.innerHTML = '';
  Object.keys(players).forEach(id=>{
    const p = players[id];
    const block = document.createElement('div');
    block.className = 'player-block';
    block.innerHTML = `<div style="font-weight:700">${p.username || 'player'}</div>`;
    const slots = document.createElement('div'); slots.className='slots';
    (p.collection||Array(8).fill(null)).forEach((it,idx)=>{
      const s = document.createElement('div'); s.className='slot';
      if(it){
        const img = document.createElement('img'); img.src=(it.type==='bellbob'?'bellbob.png':'spermbob.png');
        img.style.width='48px'; img.style.height='48px';
        s.appendChild(img);
        const meta = document.createElement('div'); meta.className='meta'; meta.textContent=`${it.rarity} $${it.mps}/s`;
        s.appendChild(meta);
        if(id===myId) attachHoldSell(s, idx);
        else attachHoldSteal(s, idx, id);
      }else s.style.opacity=0.6;
      slots.appendChild(s);
    });
    block.appendChild(slots);
    collectionsDiv.appendChild(block);
  });
}
setInterval(renderCollections,500);

// Hold-to-sell
function attachHoldSell(el, slotIndex){
  let raf=null,start=null,bar=null;
  function tick(ts){
    if(!start) start=ts;
    const pct=Math.min((ts-start)/SELL_HOLD_MS*100,100);
    bar.style.width=pct+'%';
    if(pct>=100){ cancel(); ws.send(JSON.stringify({type:'sell',slot:slotIndex})); }
    else raf=requestAnimationFrame(tick);
  }
  function startHold(){
    if(bar) bar.remove();
    bar=document.createElement('div'); bar.className='steal-bar'; el.appendChild(bar);
    start=null; raf=requestAnimationFrame(tick);
  }
  function cancel(){ if(raf) cancelAnimationFrame(raf); raf=null; start=null; if(bar){bar.remove(); bar=null;} }
  el.addEventListener('mousedown',e=>{ if(e.button!==0) return; startHold(); });
  el.addEventListener('mouseup',cancel); el.addEventListener('mouseleave',cancel);
  el.addEventListener('contextmenu',e=>{ e.preventDefault(); ws.send(JSON.stringify({type:'sell',slot:slotIndex})); });
}

// Hold-to-steal
function attachHoldSteal(el,slotIndex,victimId){
  let raf=null,start=null,bar=null;
  function tick(ts){
    if(!start) start=ts;
    const pct=Math.min((ts-start)/STEAL_TIMEOUT_MS*100,100);
    bar.style.width=pct+'%';
    if(pct>=100){ cancel(); }
    else raf=requestAnimationFrame(tick);
  }
  function startHold(){
    if(bar) bar.remove();
    bar=document.createElement('div'); bar.className='steal-bar'; el.appendChild(bar);
    ws.send(JSON.stringify({type:'stealStart',victimId,slot:slotIndex}));
    start=null; raf=requestAnimationFrame(tick);
  }
  function cancel(){ if(raf) cancelAnimationFrame(raf); raf=null; start=null; if(bar){bar.remove(); bar=null;} }
  el.addEventListener('mousedown',e=>{ if(e.button!==0) return; startHold(); });
  el.addEventListener('mouseup',cancel); el.addEventListener('mouseleave',cancel);
}

// update money
setInterval(()=>{ if(myId && players[myId]) moneyVal.textContent=Math.floor(players[myId].money||0); },500);

// block steal via arrow keys
document.addEventListener('keydown',e=>{
  if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)){
    if(!myId) return;
    ws.send(JSON.stringify({type:'stealBlocked',victimId:myId,slot:null}));
  }
});
</script>
</body>
</html>


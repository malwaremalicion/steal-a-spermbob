<script>
/* ================= CONFIG ================= */
const WS_URL = 'wss://spermbob-server.onrender.com';
const START_MONEY = 30;
const SLOTS = 8;

/* ================= STATE ================= */
let ws = null;
let playerId = null;
let username = null;
let roomCode = null;
let money = START_MONEY;
let collection = Array(SLOTS).fill(null);
let players = {};
let activeSteals = {}; // key victimId_slot -> {progress, interval}

/* rarity filters */
const rarityFilter = {
  'Common': 'drop-shadow(0 0 6px rgba(255,255,255,0.06))',
  'Uncommon': 'drop-shadow(0 0 8px rgba(0,255,120,0.12))',
  'Rare': 'drop-shadow(0 0 8px rgba(0,120,255,0.16))',
  'Epic': 'drop-shadow(0 0 10px rgba(200,50,255,0.18))'
};

/* ================= DOM ================= */
const moneyVal = document.getElementById('moneyVal');
const statusEl = document.getElementById('status');
const playerNamesEl = document.getElementById('playerNames');
const collectionsArea = document.getElementById('collectionsArea');
const road = document.getElementById('road');
const roomLabel = document.getElementById('roomLabel');
const bgm = document.getElementById('bgm');
const usernameScreen = document.getElementById('usernameScreen');
const usernameInput = document.getElementById('usernameInput');
const roomInput = document.getElementById('roomInput');
const enterBtn = document.getElementById('enterBtn');
const roomCodeField = document.getElementById('roomCode');
const createRoomBtn = document.getElementById('createRoom');
const joinRoomBtn = document.getElementById('joinRoom');

/* ================= HELPERS ================= */
function setStatus(s){ statusEl.textContent = s; }
function updateMoneyUI(){ moneyVal.textContent = Math.floor(money); }
function safeSend(obj){
  if(ws && ws.readyState===WebSocket.OPEN) ws.send(JSON.stringify(obj));
}

/* ================= USER JOIN ================= */
enterBtn.onclick = ()=> {
  const n = usernameInput.value.trim();
  const rc = roomInput.value.trim() || Math.random().toString(36).slice(2,6);
  if(!n) return alert('Pick a username');
  username = n; roomCode = rc;
  usernameScreen.style.display = 'none';
  roomCodeField.value = roomCode;
  roomLabel.textContent = roomCode;
  bgm.play().catch(()=>{});
  connectWS();
};

createRoomBtn.onclick = ()=> {
  const c = Math.random().toString(36).slice(2,6);
  roomCodeField.value = c; roomInput.value = c;
  roomCode = c; roomLabel.textContent = c;
};

joinRoomBtn.onclick = ()=> {
  const c = roomCodeField.value.trim();
  if(!c) return alert('Enter room code');
  roomInput.value = c; roomCode = c;
  if(ws && ws.readyState===WebSocket.OPEN){
    safeSend({ type:'joinRoom', username, roomCode: c });
  } else {
    usernameScreen.style.display = 'none';
    connectWS();
  }
};

/* ================= WEBSOCKET ================= */
let reconnectTimer = null;
function connectWS(){
  if(ws && (ws.readyState===WebSocket.OPEN || ws.readyState===WebSocket.CONNECTING)) return;
  setStatus('Connecting...');
  ws = new WebSocket(WS_URL);

  ws.onopen = ()=> {
    setStatus('Connected');
    safeSend({ type:'joinRoom', username, roomCode });
    safeSend({ type:'update', collection, money });
  };

  ws.onmessage = ev=>{
    let msg;
    try{ msg = JSON.parse(ev.data); }catch(e){ return; }
    handleMessage(msg);
  };

  ws.onclose = ()=>{
    setStatus('Disconnected — reconnecting...');
    Object.keys(activeSteals).forEach(k=> stopStealUI(keyToObj(k)));
    activeSteals = {};
    clearTimeout(reconnectTimer);
    reconnectTimer = setTimeout(connectWS, 2000);
  };

  ws.onerror = err=>{
    console.error('WebSocket error', err);
    setStatus('Connection error');
  };
}

/* ================= MESSAGE HANDLER ================= */
function handleMessage(msg){
  if(msg.type==='roomUpdate'){
    players = msg.players || {};
    if(msg.you) playerId = msg.you;
    if(playerId && players[playerId] && !collection.some(Boolean)){
      collection = players[playerId].collection.slice();
      money = players[playerId].money ?? money;
      updateMoneyUI();
    }
    renderCollections();
    renderPlayerList();
    return;
  }

  if(msg.type==='buy' && msg.itemId){
    document.querySelectorAll('.walker').forEach(w=>{
      if(w.dataset.id===msg.itemId) w.remove();
    });
    return;
  }

  if(msg.type==='stealStart'){
    startStealBar(msg.thiefId,msg.victimId,msg.slot);
    if(msg.victimId===playerId) alert(`Someone is stealing slot ${msg.slot}! Press arrow key to block.`);
  }

  if(msg.type==='stealBlocked'){
    stopStealBar(msg.thiefId,msg.victimId,msg.slot);
    if(msg.victimId===playerId) alert('You blocked a steal!');
  }

  if(msg.type==='stealSuccess'){
    stopStealBar(msg.thiefId,msg.victimId,msg.slot);
    if(msg.victimId===playerId) alert('One of your items was stolen!');
    if(msg.thiefId===playerId) alert('You stole an item!');
  }
}

/* ================= UI ================= */
function renderPlayerList(){
  playerNamesEl.innerHTML = '';
  const ids = Object.keys(players);
  if(ids.length===0) playerNamesEl.textContent='—';
  ids.forEach(id=>{
    const d=document.createElement('div');
    d.textContent = (players[id].username||'player')+(id===playerId?' (You)':'');
    playerNamesEl.appendChild(d);
  });
}

function renderCollections(){
  collectionsArea.innerHTML='';
  const ids = Object.keys(players);
  const sorted = [];
  if(playerId && players[playerId]) sorted.push(playerId);
  ids.forEach(id=>{ if(id!==playerId) sorted.push(id); });

  sorted.forEach(id=>{
    const p = players[id];
    const block=document.createElement('div');
    block.className='player-block';
    const title=document.createElement('div');
    title.className='player-name';
    title.textContent=(p?.username||'player')+(id===playerId?' (You)':'');
    block.appendChild(title);

    const slots=document.createElement('div'); slots.className='slots';
    const arr = p?.collection||Array(SLOTS).fill(null);

    for(let i=0;i<SLOTS;i++){
      const slot=document.createElement('div'); slot.className='slot';
      if(arr[i]){
        const it=arr[i];
        const img=document.createElement('img'); img.src=it.type==='bellbob'?'bellbob.png':'spermbob.png';
        img.style.filter=rarityFilter[it.rarity]||''; slot.appendChild(img);
        const meta=document.createElement('div'); meta.className='meta';
        meta.textContent=`${it.rarity} | $${it.mps}/s`; slot.appendChild(meta);

        if(id===playerId){
          let hold=null;
          slot.addEventListener('mousedown',e=>{
            if(e.button!==0) return;
            hold=setTimeout(()=>{
              const refund=Math.max(1,Math.floor(it.mps*5));
              money+=refund; updateMoneyUI();
              collection[i]=null;
              safeSend({type:'update', collection, money});
              renderCollections();
            },5000);
          });
          slot.addEventListener('mouseup',()=>clearTimeout(hold));
          slot.addEventListener('mouseleave',()=>clearTimeout(hold));
          slot.addEventListener('contextmenu',e=>{
            e.preventDefault();
            const refund=Math.max(1,Math.floor(it.mps*5));
            money+=refund; updateMoneyUI();
            collection[i]=null;
            safeSend({type:'update', collection, money});
            renderCollections();
          });
        } else {
          slot.addEventListener('click',()=> safeSend({type:'stealStart', victimId:id, slot:i}));
        }
      } else slot.style.opacity=0.6;
      slots.appendChild(slot);
    }
    block.appendChild(slots);
    collectionsArea.appendChild(block);
  });
}

/* ================= Walkers ================= */
function spawnWalker(){
  const rarities=[
    {name:'Common', cost:10, mps:1},
    {name:'Uncommon', cost:25, mps:3},
    {name:'Rare', cost:60, mps:7},
    {name:'Epic', cost:150, mps:15}
  ];
  const types=['spermbob','bellbob'];
  const type=types[Math.floor(Math.random()*types.length)];
  const rar=rarities[Math.floor(Math.random()*rarities.length)];
  const el=document.createElement('div');
  el.className='walker';
  el.dataset.id=Math.random().toString(36).slice(2,9);
  el.dataset.type=type; el.dataset.rarity=rar.name; el.dataset.cost=rar.cost; el.dataset.mps=rar.mps;
  el.style.left='-60px'; el.style.top=(16+Math.random()*96)+'px';
  const img=document.createElement('img'); img.src=type==='bellbob'?'bellbob.png':'spermbob.png';
  img.style.filter=rarityFilter[rar.name]||''; el.appendChild(img);
  const tag=document.createElement('div'); tag.className='tag'; tag.textContent=`${rar.name} • $${rar.cost} • $${rar.mps}/s`;
  el.appendChild(tag);
  el.addEventListener('click',()=> attemptBuy(el));
  road.appendChild(el);

  let x=-80;
  const speed=0.5+Math.random()*1.2;
  function step(){ x+=speed; el.style.left=x+'px'; if(x>window.innerWidth+80) el.remove(); else requestAnimationFrame(step);}
  step();
}

function attemptBuy(el){
  const cost=Number(el.dataset.cost);
  if(money<cost){ alert('Not enough money'); return; }
  const freeIndex=collection.findIndex(s=>!s);
  if(freeIndex===-1){ alert('Collection full — sell something'); return; }
  money-=cost; updateMoneyUI();
  collection[freeIndex]={type:el.dataset.type, rarity:el.dataset.rarity, mps:Number(el.dataset.mps)};
  renderCollections();
  safeSend({type:'buy', slot:freeIndex, item:collection[freeIndex], itemId:el.dataset.id});
  safeSend({type:'update', collection, money});
  el.remove();
}

setInterval(spawnWalker,2000);

/* ================= Money Tick ================= */
setInterval(()=>{
  let inc=0; for(let i=0;i<SLOTS;i++) if(collection[i]) inc+=collection[i].mps||0;
  if(inc>0){ money+=inc; updateMoneyUI(); safeSend({type:'update', collection, money}); }
},1000);

/* ================= Steal UI ================= */
function keyToObj(k){ const parts=k.split('_'); return {victimId:parts[0], slot:Number(parts[1])}; }
function objToKey(victimId,slot){ return `${victimId}_${slot}`; }

function startStealBar(thiefId,victimId,slot){
  const key=objToKey(victimId,slot);
  if(activeSteals[key]) return;
  activeSteals[key]={progress:0, interval:null, thiefId, victimId, slot};
  renderCollections();
  const idx=getPlayerIndex(victimId); if(idx===-1) return;
  const block=document.querySelectorAll('.player-block')[idx];
  const slotEl=block.querySelectorAll('.slot')[slot];
  const bar=slotEl.querySelector('.steal-bar') || (()=>{ const b=document.createElement('div'); b.className='steal-bar'; slotEl.appendChild(b); return b; })();
  activeSteals[key].interval=setInterval(()=>{
    activeSteals[key].progress++;
    bar.style.width=(activeSteals[key].progress*100/15)+'%';
    if(activeSteals[key].progress>=15){
      clearInterval(activeSteals[key].interval);
      safeSend({type:'stealSuccess', victimId, slot});
      delete activeSteals[key];
    }
  },1000);
}

function stopStealBar(thiefId,victimId,slot){
  const key=objToKey(victimId,slot);
  const e=activeSteals[key]; if(!e) return;
  clearInterval(e.interval);
  const idx=getPlayerIndex(victimId); if(idx!==-1){
    const block=document.querySelectorAll('.player-block')[idx];
    const bar=block.querySelectorAll('.slot')[slot]?.querySelector('.steal-bar');
    if(bar) bar.style.width='0%';
  }
  delete activeSteals[key];
}

function stopStealUI(detail){ if(!detail) return; stopStealBar(detail.thiefId, detail.victimId, detail.slot); }

document.addEventListener('keydown', e=>{
  if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)){
    Object.keys(activeSteals).forEach(k=>{
      const obj=keyToObj(k); const entry=activeSteals[k];
      if(entry && entry.victimId===playerId){
        safeSend({type:'stealBlocked', victimId:entry.victimId, slot:entry.slot});
        stopStealBar(entry.thiefId,entry.victimId,entry.slot);
      }
    });
  }
});

function getPlayerIndex(pid){
  const blocks=document.querySelectorAll('.player-block');
  for(let i=0;i<blocks.length;i++){
    const name=blocks[i].querySelector('.player-name')?.textContent||'';
    const n=name.replace(/\s+\(You\)$/,'');
    if(players[pid] && players[pid].username && n.startsWith(players[pid].username)) return i;
  }
  return -1;
}

/* ================= INITIAL UI ================= */
updateMoneyUI();
setStatus('Waiting for username...');
window.renderCollections=renderCollections;
</script>

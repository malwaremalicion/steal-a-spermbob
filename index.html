<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Steal A Spermbob</title>
<style>
 body { background:#222; color:#fff; font-family:Arial; overflow:hidden; }
 #road { position:absolute; left:0; top:50%; width:100%; height:120px; background:#444; }
 .walker { position:absolute; top:20px; width:64px; height:64px; }
 .label { position:absolute; top:-20px; width:100%; text-align:center; font-size:12px; color:white; text-shadow:0 0 4px black; }
 #collection { position:absolute; bottom:10px; left:50%; transform:translateX(-50%); display:flex; gap:10px; }
 .slot { width:80px; height:80px; background:#333; border:2px solid #555; position:relative; }
 .slot img { width:100%; height:100%; }
 #money { position:absolute; left:10px; top:10px; font-size:22px; }
 #saveLoad { position:absolute; right:10px; top:10px; }
 #mpBox { position:absolute; right:10px; bottom:10px; width:220px; background:#111; padding:10px; border:1px solid #555; }
 #mpStatus { font-size:12px; margin-bottom:5px; }
 textarea { width:100%; height:60px; background:#000; color:#0f0; font-size:10px; }
 #stealWarn { position:absolute; top:40%; left:50%; transform:translate(-50%,-50%); background:red; padding:20px; font-size:20px; display:none; }
  .walker img { width: 48px !important; height: auto !important; }
</style>
</head>
<body>
<div id="money">$0</div>
<div id="road"></div>
<div id="collection"></div>
<div id="saveLoad">
 <button id="saveBtn">Save</button>
 <button id="loadBtn">Load</button>
</div>
<div id="mpBox">
 <div id="mpStatus">Not connected</div>
 <button id="hostBtn">Host Room</button>
 <button id="joinBtn">Join Room</button>
 <textarea id="signalData"></textarea>
 <button id="copySig">Copy</button>
 <button id="applySig">Apply Remote</button>
</div>
<div id="stealWarn"></div>
<audio id="bgm" src="bgm.mp3" loop></audio>
<script>
const rarities = [
 {name:"Common", tint:"rgba(255,255,255,0)", cost:10, mps:1},
 {name:"Uncommon", tint:"rgba(0,255,0,0.3)", cost:25, mps:3},
 {name:"Rare", tint:"rgba(0,100,255,0.3)", cost:60, mps:7},
 {name:"Epic", tint:"rgba(170,0,255,0.3)", cost:150, mps:15}
];

let money=0;
let collection = Array(8).fill(null);
const road=document.getElementById("road");
const coll=document.getElementById("collection");
const stealWarn=document.getElementById("stealWarn");
const mpStatus=document.getElementById("mpStatus");

// Multiplayer simplified: Direct P2P sync of walkers & collections
let pc=null;
let dc=null;

function setupCollectionUI(){
 coll.innerHTML="";
 for(let i=0;i<8;i++){
  let d=document.createElement("div");
  d.className="slot";
  d.dataset.index=i;
  d.onmousedown=()=>holdSell(i);
  coll.appendChild(d);
 }
}
setupCollectionUI();

function spawnWalker(){
 let t = Math.random()<0.5?"spermbob":"bellbob";
 let rarity = rarities[Math.floor(Math.random()*rarities.length)];
 let x = -100;
 let div=document.createElement("div");
 div.className="walker";
 div.style.left=x+"px";
 div.dataset.type=t;
 div.dataset.rarity=rarity.name;
 div.dataset.cost=rarity.cost;
 div.dataset.mps=rarity.mps;

 let img=document.createElement("img");
 img.src = t=="spermbob"?"spermbob.png":"bellbob.png";
 img.style.filter = `drop-shadow(0 0 5px ${rarity.tint})`;
 div.appendChild(img);

 let label=document.createElement("div");
 label.className="label";
 label.innerText=`${rarity.name} | $${rarity.mps}/s | Cost: ${rarity.cost}`;
 div.appendChild(label);

 div.onclick=()=>buy(div);
 road.appendChild(div);

 let speed=0.5+Math.random()*0.5;
 function move(){
  x+=speed;
  div.style.left=x+"px";
  if(x>window.innerWidth+100){
    div.remove();
  } else requestAnimationFrame(move);
 }
 move();

 if(dc) send({type:"spawn", t, rarity:rarity.name});
}
setInterval(spawnWalker,2000);

function buy(w){
 let cost=Number(w.dataset.cost);
 if(money<cost) return;
 let slot=collection.findIndex(s=>!s);
 if(slot==-1) return;
 money-=cost;
 let item={ type:w.dataset.type, rarity:w.dataset.rarity, mps:Number(w.dataset.mps) };
 collection[slot]=item;
 renderCollection();
 if(dc) send({type:"buy", slot, item});
 w.remove();
 if(dc) send({type:"despawn", id:w.id});
}

function renderCollection(){
 for(let i=0;i<8;i++){
  let d=coll.children[i];
  d.innerHTML="";
  let it=collection[i];
  if(!it) continue;
  let img=document.createElement("img");
  img.src = it.type=="spermbob"?"spermbob.png":"bellbob.png";
  d.appendChild(img);
  let lab=document.createElement("div");
  lab.className="label";
  lab.innerText=`${it.rarity} | $${it.mps}/s`;
  d.appendChild(lab);
  d.onmousedown=()=>holdSell(i);
 }
}

setInterval(()=>{
 for(let it of collection){ if(it) money+=it.mps; }
 document.getElementById("money").innerText="$"+money;
},1000);

function holdSell(i){
 let t=setTimeout(()=>{
   if(collection[i]){
     collection[i]=null;
     renderCollection();
     if(dc) send({type:"sell", slot:i});
   }
 },5000);
 document.onmouseup=()=>clearTimeout(t);
}

function save(){ localStorage.setItem("spermSave",JSON.stringify({money,collection})); }
function load(){ let d=JSON.parse(localStorage.getItem("spermSave")||"{}"); if(d.collection){money=d.money;collection=d.collection;renderCollection();} }

document.getElementById("saveBtn").onclick=save;
document.getElementById("loadBtn").onclick=load;

document.getElementById("bgm").play();

function send(o){ if(dc&&dc.readyState==="open") dc.send(JSON.stringify(o)); }

function host(){
 pc=new RTCPeerConnection();
 dc=pc.createDataChannel("c");
 setupDC();
 pc.onicecandidate=e=>{
  document.getElementById("signalData").value=JSON.stringify(pc.localDescription);
 };
 pc.createOffer().then(o=>pc.setLocalDescription(o));
 mpStatus.innerText="Hosting";
}

function join(){
 pc=new RTCPeerConnection();
 pc.ondatachannel=e=>{ dc=e.channel; setupDC(); };
 pc.onicecandidate=e=>{
  document.getElementById("signalData").value=JSON.stringify(pc.localDescription);
 };
 let remote=JSON.parse(document.getElementById("signalData").value);
 pc.setRemoteDescription(remote).then(()=>{
  pc.createAnswer().then(a=>pc.setLocalDescription(a));
 });
 mpStatus.innerText="Joining";
}

function setupDC(){
 dc.onopen=()=>{ mpStatus.innerText="Connected"; syncState(); };
 dc.onmessage=e=>handle(JSON.parse(e.data));
}

function syncState(){ send({type:"full", money, collection}); }

function handle(d){
 if(d.type=="full"){ money=d.money; collection=d.collection; renderCollection(); }
 if(d.type=="spawn") spawnWalker();
 if(d.type=="buy"){ collection[d.slot]=d.item; renderCollection(); }
 if(d.type=="sell"){ collection[d.slot]=null; renderCollection(); }
}

document.getElementById("hostBtn").onclick=host;
document.getElementById("joinBtn").onclick=join;
document.getElementById("copySig").onclick=()=>navigator.clipboard.writeText(document.getElementById("signalData").value);
document.getElementById("applySig").onclick=()=>{
 let r=JSON.parse(document.getElementById("signalData").value);
 pc.setRemoteDescription(r);
};
</script>
</body>
</html>
